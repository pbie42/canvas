<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Page Title</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
	<!-- <script src="main.js"></script> -->
</head>

<body>
	<canvas id="gameCanvas" width="800" height="600"></canvas>
	<script>
		var canvas, canvasContext
		var ballX = 75
		var ballY = 75
		var ballSpeedX = 5
		var ballSpeedY = 7
		var mouseX
		var mouseY

		const TRACK_W = 40
		const TRACK_H = 40
		const TRACK_COLS = 20
		const TRACK_ROWS = 15
		const TRACK_GAP = 2

		var trackGrid = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
			1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
			1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
			1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
			1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
			1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]


		function updateMousePos(e) {
			var rect = canvas.getBoundingClientRect()
			var root = document.documentElement

			mouseX = e.clientX - rect.left - root.scrollLeft
			mouseY = e.clientY - rect.top - root.scrollTop

			// Test Cheat 
			// ballX = mouseX
			// ballY = mouseY
			// ballSpeedX = 4
			// ballSpeedY = -4
		}

		window.onload = function () {
			canvas = document.getElementById('gameCanvas')
			canvasContext = canvas.getContext('2d')

			const framesPerSecond = 30
			ballReset()
			setInterval(updateAll, 1000 / framesPerSecond)

			canvas.addEventListener('mousemove', updateMousePos)

		}

		function updateAll() {
			moveAll()
			drawAll()
		}

		function ballReset() {
			ballX = canvas.width / 2
			ballY = canvas.height / 2
		}

		function ballMove() {
			ballX += ballSpeedX
			ballY += ballSpeedY
			if (ballX > canvas.width && ballSpeedX > 0.0) ballSpeedX *= -1 // Right
			if (ballX < 0 && ballSpeedX < 0.0) ballSpeedX *= - 1 // Left
			if (ballY < 0 && ballSpeedY < 0.0) ballSpeedY *= - 1 // Top
			if (ballY > canvas.height) {
				ballReset()
			} // Bottom
		}

		function isTrackAtColRow(col, row) {
			if (col >= 0 && col < TRACK_COLS && row >= 0 && row < TRACK_ROWS) {
				var trackIndexUnderCoord = rowColToArrayIndex(col, row)
				return (trackGrid[trackIndexUnderCoord] === 1)
			} else return false
		}

		function ballTrackHandling() {
			var ballTrackCol = Math.floor(ballX / TRACK_W)
			var ballTrackRow = Math.floor(ballY / TRACK_H)
			var trackIndexUnderBall = rowColToArrayIndex(ballTrackCol, ballTrackRow)

			if (ballTrackCol >= 0 && ballTrackCol < TRACK_COLS &&
				ballTrackRow >= 0 && ballTrackRow < TRACK_ROWS) {
				if (isTrackAtColRow(ballTrackCol, ballTrackRow)) {
					var prevBallX = ballX - ballSpeedX
					var prevBallY = ballY - ballSpeedY
					var prevTrackCol = Math.floor(prevBallX / TRACK_W)
					var prevTrackRow = Math.floor(prevBallY / TRACK_H)

					var bothTestsFailed = true

					if (prevTrackCol !== ballTrackCol) {
						if (isTrackAtColRow(prevTrackCol, ballTrackRow) === false) {
							bothTestsFailed = false
							ballSpeedX *= -1
						}
					}
					if (prevTrackRow !== ballTrackRow) {
						if (isTrackAtColRow(ballTrackCol, prevTrackRow) === false) {
							bothTestsFailed = false
							ballSpeedY *= -1
						}
					}
					if (bothTestsFailed) {
						ballSpeedX *= -1
						ballSpeedY *= -1
					}
				}
			}
		}

		function moveAll() {
			ballMove()
			ballTrackHandling()
		}

		function rowColToArrayIndex(col, row) {
			return col + TRACK_COLS * row
		}

		function drawTracks() {
			for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++)
				for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
					let arrayIndex = rowColToArrayIndex(eachCol, eachRow)
					if (trackGrid[arrayIndex] === 1)
						colorRect(TRACK_W * eachCol, TRACK_H * eachRow, TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP, 'blue')
				}
		}

		function drawAll() {
			colorRect(0, 0, canvas.width, canvas.height, 'black') // Clear Screen
			colorCircle(ballX, ballY, 10, 'white') // Draw Ball

			drawTracks()
			// var mouseTrackCol = Math.floor(mouseX / TRACK_W)
			// var mouseTrackRow = Math.floor(mouseY / TRACK_H)
			// var trackIndexUnderMouse = rowColToArrayIndex(mouseTrackCol, mouseTrackRow)
			// colorText(mouseTrackCol + ', ' + mouseTrackRow + ': ' + trackIndexUnderMouse, mouseX, mouseY, 'yellow')
		}

		function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight)
		}

		function colorCircle(centerX, centerY, radius, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.beginPath()
			canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true)
			canvasContext.fill()
		}

		function colorText(showWords, textX, textY, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.fillText(showWords, textX, textY)
		}
	</script>
</body>

</html>
