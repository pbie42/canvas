<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Page Title</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
	<!-- <script src="main.js"></script> -->
</head>

<body>
	<canvas id="gameCanvas" width="800" height="600"></canvas>
	<script>
		var carPic = document.createElement("img")
		var carPicLoaded = false
		var canvas, canvasContext
		var carX = 75
		var carY = 75
		var carAng = 0
		var carSpeedX = 5
		var carSpeedY = 7
		var mouseX
		var mouseY

		const TRACK_W = 40
		const TRACK_H = 40
		const TRACK_COLS = 20
		const TRACK_ROWS = 15
		const TRACK_GAP = 2

		var trackGrid = [
			1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
			1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,
			1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1,
			1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1,
			1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 0, 2, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1,
			1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1,
			1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1,
			1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]


		function updateMousePos(e) {
			var rect = canvas.getBoundingClientRect()
			var root = document.documentElement

			mouseX = e.clientX - rect.left - root.scrollLeft
			mouseY = e.clientY - rect.top - root.scrollTop

			// Test Cheat
			// carX = mouseX
			// carY = mouseY
			// carSpeedX = 4
			// carSpeedY = -4
		}

		window.onload = function () {
			canvas = document.getElementById('gameCanvas')
			canvasContext = canvas.getContext('2d')

			const framesPerSecond = 30
			carReset()
			setInterval(updateAll, 1000 / framesPerSecond)

			canvas.addEventListener('mousemove', updateMousePos)

			carPic.onload = function () {
				carPicLoaded = true
			}

			carPic.src = 'player1car.png'

		}

		function updateAll() {
			moveAll()
			drawAll()
		}

		function carReset() {
			for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++)
				for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
					let arrayIndex = rowColToArrayIndex(eachCol, eachRow)
					if (trackGrid[arrayIndex] === 2) {
						trackGrid[arrayIndex] = 0
						carX = eachCol * TRACK_W + TRACK_W / 2
						carY = eachRow * TRACK_H + TRACK_H / 2
					}
				}
		}

		function carMove() {
			// carX += carSpeedX
			// carY += carSpeedY
			carAng += 0.02
			if (carX > canvas.width && carSpeedX > 0.0) carSpeedX *= -1 // Right
			if (carX < 0 && carSpeedX < 0.0) carSpeedX *= - 1 // Left
			if (carY < 0 && carSpeedY < 0.0) carSpeedY *= - 1 // Top
			if (carY > canvas.height) {
				carReset()
			} // Bottom
		}

		function isTrackAtColRow(col, row) {
			if (col >= 0 && col < TRACK_COLS && row >= 0 && row < TRACK_ROWS) {
				var trackIndexUnderCoord = rowColToArrayIndex(col, row)
				return (trackGrid[trackIndexUnderCoord] === 1)
			} else return false
		}

		function carTrackHandling() {
			var carTrackCol = Math.floor(carX / TRACK_W)
			var carTrackRow = Math.floor(carY / TRACK_H)
			var trackIndexUnderCar = rowColToArrayIndex(carTrackCol, carTrackRow)

			if (carTrackCol >= 0 && carTrackCol < TRACK_COLS &&
				carTrackRow >= 0 && carTrackRow < TRACK_ROWS) {
				if (isTrackAtColRow(carTrackCol, carTrackRow)) {
					var prevCarX = carX - carSpeedX
					var prevCarY = carY - carSpeedY
					var prevTrackCol = Math.floor(prevCarX / TRACK_W)
					var prevTrackRow = Math.floor(prevCarY / TRACK_H)

					var bothTestsFailed = true

					if (prevTrackCol !== carTrackCol) {
						if (isTrackAtColRow(prevTrackCol, carTrackRow) === false) {
							bothTestsFailed = false
							carSpeedX *= -1
						}
					}
					if (prevTrackRow !== carTrackRow) {
						if (isTrackAtColRow(carTrackCol, prevTrackRow) === false) {
							bothTestsFailed = false
							carSpeedY *= -1
						}
					}
					if (bothTestsFailed) {
						carSpeedX *= -1
						carSpeedY *= -1
					}
				}
			}
		}

		function moveAll() {
			carMove()
			carTrackHandling()
		}

		function rowColToArrayIndex(col, row) {
			return col + TRACK_COLS * row
		}

		function drawTracks() {
			for (let eachRow = 0; eachRow < TRACK_ROWS; eachRow++)
				for (let eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
					let arrayIndex = rowColToArrayIndex(eachCol, eachRow)
					if (trackGrid[arrayIndex] === 1)
						colorRect(TRACK_W * eachCol, TRACK_H * eachRow, TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP, 'blue')
				}
		}

		function drawAll() {
			colorRect(0, 0, canvas.width, canvas.height, 'black') // Clear Screen
			// colorCircle(carX, carY, 10, 'white') // Draw Car
			if (carPicLoaded) {
				drawBitmapCenteredWithRotation(carPic, carX, carY, carAng)
			}
			drawTracks()
		}

		function drawBitmapCenteredWithRotation(useBitmap, atX, atY, withAng) {
			canvasContext.save()
			canvasContext.translate(atX, atY)
			canvasContext.rotate(withAng)
			canvasContext.drawImage(useBitmap, -useBitmap.width / 2, -useBitmap.height / 2)
			canvasContext.restore()
		}

		function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight)
		}

		function colorCircle(centerX, centerY, radius, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.beginPath()
			canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true)
			canvasContext.fill()
		}

		function colorText(showWords, textX, textY, fillColor) {
			canvasContext.fillStyle = fillColor
			canvasContext.fillText(showWords, textX, textY)
		}
	</script>
</body>

</html>
